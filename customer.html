<!DOCTYPE html>
<html>
<head>
    <title>Customer Terminal</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .menu-item { 
            border: 1px solid #ddd; 
            margin: 10px; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            display: inline-block; 
            width: 200px; 
            vertical-align: top; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .menu-grid { display: flex; flex-wrap: wrap; gap: 15px; }
        .menu-image { 
            width: 100%; 
            height: 120px; 
            background: #f0f0f0; 
            border-radius: 6px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #999; 
            font-size: 12px;
        }
        .order-status { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .bill-section { background: #e8f5e9; padding: 10px 15px; margin: 10px 0; border-radius: 6px; border: 2px solid #4caf50; }
        .bill-total { font-size: 18px; font-weight: bold; color: #2e7d32; }
        .cart-icon { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: white; 
            color: #333; 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 24px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .cart-count { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: #f44336; 
            color: white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000;
        }
        .modal-content { 
            background: white; 
            margin: 10% auto; 
            padding: 20px; 
            width: 80%; 
            max-width: 500px; 
            border-radius: 8px;
        }
        button { padding: 10px 15px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        h1, h3 { color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Restaurant Order - Table <span id="tableId"></span></h1>
        
        <div class="bill-section">
            <span style="font-size: 16px;">Total: </span><span class="bill-total" id="billTotal">$0.00</span>
            <span id="billDetails" style="margin-left: 15px; font-size: 12px; color: #666;"></span>
        </div>
        
        <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
            <h4 style="margin: 0 0 10px 0;">Search & Filter</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="What would you like to eat?" 
                       style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="filterMenu()">
                <select id="categoryFilter" onchange="filterMenu()" 
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">All Categories</option>
                </select>
            </div>
        </div>
        
        <div id="menu"></div>
        
        <h3>Order History & Status</h3>
        <div id="orderStatus"></div>
    </div>

    <div class="cart-icon" onclick="openCart()">
        ðŸ›’
        <div class="cart-count" id="cartCount" style="display: none;">0</div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Your Order</h3>
            <div id="cartItems"></div>
            <div style="margin: 20px 0; font-weight: bold;" id="cartTotal"></div>
            <button onclick="confirmOrder()" style="background: #4caf50; margin-right: 10px;">Confirm Order</button>
            <button onclick="closeCart()" style="background: #f44336;">Cancel</button>
        </div>
    </div>

    <script>
        const socket = io();
        const tableId = new URLSearchParams(window.location.search).get('table') || '1';
        document.getElementById('tableId').textContent = tableId;
        
        let menu = [];
        let cart = JSON.parse(localStorage.getItem(`cart_${tableId}`)) || [];
        let orderHistory = [];
        let sessionId = null;
        
        socket.emit('joinTable', tableId);
        
        // Load menu and order history
        Promise.all([
            fetch('/menu').then(res => res.json()),
            fetch(`/orders/history/${tableId}`).then(res => res.json()),
            fetch(`/bill/${tableId}`).then(res => res.json())
        ]).then(([menuData, historyData, billData]) => {
            menu = menuData;
            orderHistory = historyData;
            displayMenu();
            updateCartIcon();
            displayOrderHistory();
            displayBill(billData);
        });
        
        function displayMenu(filteredMenu = null) {
            const menuToShow = filteredMenu || menu;
            const menuDiv = document.getElementById('menu');
            menuDiv.innerHTML = '<h3>Menu</h3><div class="menu-grid">' + 
                menuToShow.map(item => `
                    <div class="menu-item">
                        <div class="menu-image">Image</div>
                        <h4 style="margin: 0 0 5px 0;">${item.name}</h4>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">$${item.price}</p>
                        <button onclick="addToCart(${item.id})" style="width: 100%;">Add to Cart</button>
                    </div>
                `).join('') + '</div>';
            
            // Populate categories dropdown (only once)
            if (!filteredMenu) {
                const categories = [...new Set(menu.map(item => item.category).filter(Boolean))];
                const categorySelect = document.getElementById('categoryFilter');
                categorySelect.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }
        }
        
        function filterMenu() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            const filtered = menu.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || item.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });
            
            displayMenu(filtered);
        }
        
        function addToCart(itemId) {
            const item = menu.find(m => m.id === itemId);
            const cartItem = cart.find(c => c.id === itemId);
            
            if (cartItem) {
                cartItem.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            localStorage.setItem(`cart_${tableId}`, JSON.stringify(cart));
            updateCartIcon();
        }
        
        function updateCartIcon() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const countElement = document.getElementById('cartCount');
            if (cartCount > 0) {
                countElement.textContent = cartCount;
                countElement.style.display = 'flex';
            } else {
                countElement.style.display = 'none';
            }
        }
        
        function openCart() {
            if (cart.length === 0) return alert('Cart is empty');
            
            const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cartItems').innerHTML = cart.map(item => `
                <div style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div>${item.name} - $${item.price}</div>
                        <div style="color: #666; font-size: 12px;">$${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="changeQuantity(${item.id}, -1)" style="width: 30px; height: 30px; border-radius: 50%;">-</button>
                        <span style="font-weight: bold;">${item.quantity}</span>
                        <button onclick="changeQuantity(${item.id}, 1)" style="width: 30px; height: 30px; border-radius: 50%;">+</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cartTotal').textContent = `Total: $${cartTotal.toFixed(2)}`;
            document.getElementById('cartModal').style.display = 'block';
        }
        
        function closeCart() {
            document.getElementById('cartModal').style.display = 'none';
        }
        
        function changeQuantity(itemId, change) {
            const cartItem = cart.find(c => c.id === itemId);
            if (cartItem) {
                cartItem.quantity += change;
                if (cartItem.quantity <= 0) {
                    cart = cart.filter(c => c.id !== itemId);
                }
                localStorage.setItem(`cart_${tableId}`, JSON.stringify(cart));
                updateCartIcon();
                
                if (cart.length === 0) {
                    closeCart();
                } else {
                    openCart(); // Refresh the modal
                }
            }
        }
        
        function confirmOrder() {
            placeOrder();
            closeCart();
        }
        
        function placeOrder() {
            if (cart.length === 0) return alert('Cart is empty');
            
            // Create session if it doesn't exist (first order)
            const orderPromise = sessionId ? 
                Promise.resolve({ sessionId }) :
                fetch('/customer-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableId })
                }).then(res => res.json());
            
            orderPromise.then(data => {
                if (!sessionId) {
                    sessionId = data.sessionId;
                    console.log('New session created: ' + sessionId);
                }
                
                return fetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableId, items: cart, sessionId })
                });
            })
            .then(res => res.json())
            .then(order => {
                cart = [];
                localStorage.removeItem(`cart_${tableId}`);
                updateCartIcon();
                // Reload order history to avoid duplicates
                fetch(`/orders/history/${tableId}`)
                    .then(res => res.json())
                    .then(historyData => {
                        orderHistory = historyData;
                        displayOrderHistory();
                        updateBill();
                    });
                alert('Order placed!');
            });
        }
        
        function displayBill(billData) {
            document.getElementById('billTotal').textContent = `$${billData.total.toFixed(2)}`;
            document.getElementById('billDetails').textContent = 
                billData.orders > 0 ? `${billData.orders} order(s) placed` : 'No orders yet';
        }
        
        function updateBill() {
            fetch(`/bill/${tableId}`)
                .then(res => res.json())
                .then(billData => displayBill(billData));
        }
        
        function displayOrderHistory() {
            const statusDiv = document.getElementById('orderStatus');
            if (orderHistory.length === 0) {
                statusDiv.innerHTML = '<p>No orders yet</p>';
                return;
            }
            statusDiv.innerHTML = orderHistory.map(order => `
                <div class="order-status">
                    <h4>Order #${order.id} - ${order.status}</h4>
                    <p>Time: ${new Date(order.created_at).toLocaleTimeString()}</p>
                    <div>Items: ${order.items.map(item => `${item.name} x${item.quantity}`).join(', ')}</div>
                    <div>Total: $${order.total_amount}</div>
                </div>
            `).join('');
        }
        
        socket.on('orderUpdate', (order) => {
            if (order.table_id === tableId) {
                const existingOrder = orderHistory.find(o => o.id === order.id);
                if (existingOrder) {
                    existingOrder.status = order.status;
                } else {
                    orderHistory.push(order);
                }
                displayOrderHistory();
                updateBill();
            }
        });
        
        socket.on('tableReset', (resetTableId) => {
            if (resetTableId === tableId) {
                // Clear everything for fresh start
                orderHistory = [];
                cart = [];
                sessionId = null;
                localStorage.removeItem(`cart_${tableId}`);
                updateCartIcon();
                displayOrderHistory();
                displayBill({ total: 0, orders: 0 });
                alert('Table has been reset. Welcome new customers!');
            }
        });
    </script>
</body>
</html>